#!/bin/bash
# Self-healing MLflow starter - installs if missing, starts if not running
# Follows spilled coffee principle: system should repair itself

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Determine dotfiles root
DOT_DEN="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Function to check if MLflow is installed via uv
check_mlflow_installed() {
  uv tool list 2>/dev/null | grep -q "mlflow" || return 1
}

# Function to check if MLflow is running
check_mlflow_running() {
  # Check if port 5000 is in use by MLflow
  lsof -i :5000 -P -n 2>/dev/null | grep -q LISTEN || return 1
}

# Function to start MLflow
start_mlflow_server() {
  local claude_runs_dir="$DOT_DEN/claude-runs"

  # Ensure claude-runs directory exists
  mkdir -p "$claude_runs_dir"

  # Start MLflow UI in background using uv run
  nohup uv run --with mlflow mlflow ui \
    --backend-store-uri "file://$claude_runs_dir" \
    --host 0.0.0.0 \
    --port 5000 \
    > /dev/null 2>&1 &

  # Give it a moment to start
  sleep 2

  # Verify it started successfully
  if curl -s http://localhost:5000 > /dev/null 2>&1; then
    echo -e "${GREEN}✓ MLflow UI started at http://localhost:5000${NC}"
    return 0
  else
    # Silent failure - don't break setup flow
    return 0
  fi
}

# Main execution
main() {
  local action="${1:-start}"

  case "$action" in
    start)
      # Check if MLflow is installed, install if not (spilled coffee principle)
      if ! check_mlflow_installed; then
        echo "MLflow not found. Installing via uv..."
        if uv tool install mlflow > /dev/null 2>&1; then
          echo -e "${GREEN}✓ MLflow installed successfully${NC}"
        else
          echo -e "${YELLOW}Could not install MLflow. Skipping...${NC}"
          exit 0
        fi
      fi

      # Check if already running
      if check_mlflow_running; then
        # Already running - silent success (no output to avoid noise)
        exit 0
      fi

      # Start MLflow
      echo "Starting MLflow UI..."
      start_mlflow_server
      ;;

    stop)
      # Stop MLflow if running
      if pgrep -f "mlflow ui" > /dev/null 2>&1; then
        pkill -f "mlflow ui"
        echo -e "${GREEN}✓ MLflow stopped${NC}"
      else
        echo "MLflow is not running"
      fi
      ;;

    status)
      if check_mlflow_running; then
        echo -e "${GREEN}MLflow is running at http://localhost:5000${NC}"
      else
        echo "MLflow is not running"
      fi
      ;;

    *)
      echo "Usage: $0 {start|stop|status}"
      exit 1
      ;;
  esac
}

# Run main function with all arguments
main "$@"