# Claude Implementation Workflow
# THE SINGLE SOURCE OF TRUTH for @claude mentions in issues and PRs
# 
# This is the ONLY workflow that responds to @claude mentions.
# Uses the official anthropics/claude-code-action@beta to:
# - Implement issues when @claude is mentioned
# - Review PRs when @claude is mentioned
# - Create branches and push changes with proper permissions
#
# Note: Both claude[bot] and github-actions[bot] comments come from this workflow.
# The bot identity depends on the context and step being executed.
#
# Principle: subtraction-creates-value (removed duplicate workflow)
# Principle: systems-stewardship (single clear workflow to maintain)

name: Claude Implementation
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  claude-assistant:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest

    steps:
      - name: Acknowledge request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Add reactions to show Claude saw the request and is working on it
              // üëÄ = Claude saw the request
              const eyesReaction = await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
              
              console.log(`‚úÖ Successfully added üëÄ reaction to comment ${context.payload.comment.id}`);
              
              // üöÄ = Claude is implementing (for issues only, not PR reviews)
              if (context.payload.issue && !context.payload.issue.pull_request) {
                const rocketReaction = await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: 'rocket'
                });
                console.log(`‚úÖ Successfully added üöÄ reaction to comment ${context.payload.comment.id}`);
              }
            } catch (error) {
              console.error(`‚ùå Failed to add reaction: ${error.message}`);
              console.error(`Comment ID: ${context.payload.comment.id}`);
              console.error(`Repository: ${context.repo.owner}/${context.repo.repo}`);
              // Don't fail the workflow if reaction fails
              // The implementation should still proceed
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}