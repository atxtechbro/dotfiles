# Claude Implementation Workflow
# THE SINGLE SOURCE OF TRUTH for @claude mentions in issues and PRs
# 
# This workflow can be:
# 1. Triggered directly in this repo via issue/PR comments
# 2. Called as a reusable workflow from other repositories
#
# Uses the official anthropics/claude-code-action@beta to:
# - Implement issues when @claude is mentioned
# - Review PRs when @claude is mentioned
# - Create branches and push changes with proper permissions
#
# Note: Both claude[bot] and github-actions[bot] comments come from this workflow.
# The bot identity depends on the context and step being executed.
#
# Principle: subtraction-creates-value (removed duplicate workflow)
# Principle: systems-stewardship (single clear workflow to maintain)
# Principle: ose (reusable across all repositories)

name: Claude Implementation
on:
  # Allow other repos to call this workflow
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
        description: 'OAuth token for Claude Code'
      CLAUDE_TRIGGER_PAT:
        required: true
        description: 'PAT with repo and workflow scopes'
  
  # Also allow local triggers in dotfiles repo
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  workflows: write    # Allows modifying workflow files when using PAT

jobs:
  claude-assistant:
    # For workflow_call, the event context is passed from the calling workflow
    # For local triggers, we check the event directly
    if: |
      (github.event_name == 'workflow_call' || 
       (contains(github.event.comment.body, '@claude') && 
        github.event.comment.user.login == 'atxtechbro'))
    runs-on: ubuntu-latest

    steps:
      - name: Acknowledge request
        # Only run for direct triggers, not workflow_call
        if: github.event_name != 'workflow_call'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Add appropriate reaction based on context
              let reaction;
              
              if (context.payload.issue && !context.payload.issue.pull_request) {
                // üöÄ = Claude is implementing (for issues)
                reaction = 'rocket';
              } else {
                // üëÄ = Claude is reviewing (for PRs)
                reaction = 'eyes';
              }
              
              const reactionResponse = await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: reaction
              });
              
              console.log(`‚úÖ Successfully added ${reaction} reaction to comment ${context.payload.comment.id}`);
            } catch (error) {
              console.error(`‚ùå Failed to add reaction: ${error.message}`);
              console.error(`Comment ID: ${context.payload.comment.id}`);
              console.error(`Repository: ${context.repo.owner}/${context.repo.repo}`);
              // Don't fail the workflow if reaction fails
              // The implementation should still proceed
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use PAT instead of GITHUB_TOKEN to allow workflow file modifications
          # PAT must have 'repo' and 'workflow' scopes
          token: ${{ secrets.CLAUDE_TRIGGER_PAT }}

      - uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "Bash(*),LS,Read,Write,Edit,MultiEdit,Glob,Grep,Task,TodoWrite,WebFetch(domain:*),WebSearch,mcp__git,mcp__github"