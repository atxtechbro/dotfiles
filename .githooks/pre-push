#!/bin/bash
# Pre-push hook to prevent direct pushes to main/master branches
# Part of MCP server experiment - see issue #1213

protected_branches="^(main|master)$"
current_branch=$(git symbolic-ref HEAD 2>/dev/null | sed -e 's,.*/\(.*\),\1,') || {
    echo "⚠️  Warning: Could not determine current branch"
    # Continue anyway since we're checking the remote ref in the loop
}

# Check if we're pushing to a protected branch
while read local_ref local_sha remote_ref remote_sha
do
    # Extract the branch name from the remote ref
    remote_branch=$(echo "$remote_ref" | sed -e 's,.*/\(.*\),\1,')
    
    if [[ "$remote_branch" =~ $protected_branches ]]; then
        echo "⛔ Direct push to $remote_branch branch is not allowed!"
        echo ""
        echo "Please create a feature branch and use a pull request instead:"
        echo "  1. git checkout -b feature/your-feature-name"
        echo "  2. git push -u origin feature/your-feature-name"
        echo "  3. Create a pull request on GitHub"
        echo ""
        echo "This protection is in place while testing without MCP servers."
        echo "See issue #1213 for details."
        exit 1
    fi
done

exit 0